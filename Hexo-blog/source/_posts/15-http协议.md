---
title: 互联网协议
date: 2019-03-28 14:59:54
category: 互联网技术
---

为了可以帮助理解：网络优化，服务器访问，ajax请求，http协议等一系列问题，我想需要了解一下互联网协议。
互联网的核心是一系列协议，总称为"互联网协议"（Internet Protocol Suite）。它们对电脑如何连接和组网，做出了详尽的规定。理解了这些协议，就理解了互联网的原理。
<!--more-->

# 一、概述
互联网的实现，分成好几层。每一层都有自己的功能。用户接触到的，只有最上面的一层。要理解互联网，必须从最下层开始，自下而上理解每一层的功能。
- **应用层：** 规定应用程序的数据格式。
- **传输层：** 建立"端口到端口"的通信。
- **网络层：** 引进一套新的地址，使区分不同的子网络。这套地址就叫做IP地址。
- **链接层：** 对"实体层"0和1的电信号进行分组成一个个数据包，让同一子网络的计算机之间进行数据包传输。
- **实体层：** 把电脑连接起来的物理手段。它主要规定了网络的一些电气特性，作用是负责传送0和1的电信号。
- 
# 二、实体层
## (1) 背景
计算机之间要组网，要传输数据，需要先把电脑连起来，可以是用光缆、电缆、双绞线、无线电波等方式。
## (2) 功能
通过物理手段，把电脑连接起来。它主要规定了网络的一些电气特性，作用是负责传送0和1的电信号。

# 三、链接层
## (1) 背景
单纯的0和1没有任何意义，必须规定解读方式：多少个电信号算一组？每个信号位有何意义？
## (2) 功能
"链接层"对"实体层"0和1的电信号进行分组，形成一个个数据包，让同一子网络的计算机之间进行数据包传输。
## (3) 以太网协议
早期，每家公司分组方式不同。后来，被一种叫"以太网"的协议，占据了主导地位。
### 分组方式
以太网规定协议规定，一组电信号构成一个数据包，叫做"帧"（Frame）。  
每一帧分成两个部分：标头（Head）和数据（Data）。
- "标头"包含数据包的一些说明项，比如发送者、接受者、数据类型等等，长度固定为18字节。；
- "数据"则是数据包的具体内容，长度最短为46字节，最长为1500字节。

<img src="1.png" style="height:200px"/>

因此，整个"帧"最短为64字节，最长为1518字节。不然，就必须分割成多个帧进行发送。

### MAC地址
以太网协议规定，连入网络的所有设备，必须都具有"网卡"接口。数据包只能在网卡之间传输。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。每块网卡的MAC地址是独一无二的。
### 广播
假如两台主机在同一个子网络，可以通过**ARP协议**，使以太网数据包知道接收方的MAC地址。（后文有介绍ARP协议）
然后以太网协议将采用"广播"的方式，向同一个子网络内所有计算机发送数据包，让每台计算机自己判断，是否为接收方。

# 四、网络层
## (1) 背景
因为以太网协议以广播的方式传输数据，效率有限，所以只能局限在发送者所在的子网络。为此需要区分哪些MAC地址属于同一个子网络，哪些不是。如果是同一个子网络，就采用广播方式发送，否则就采用"路由"方式发送。（"路由"的意思，就是指如何向不同的子网络分发数据包，这是一个很大的主题，本文不涉及。）
## (1) 功能
"网络层"的作用是引进一套新的地址，使得我们能够区分不同的计算机是否属于同一个子网络。这套地址就叫做IP地址。
## (2) IP协议
IP地址被IP协议所定义。目前，广泛采用的是IP协议第四版，简称IPv4。这个版本规定，网络地址由32个二进制位组成。
### 子网掩码
IP协议规定里的"子网掩码"，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。把IP地址与子网掩码进行"按位与"运算，结果相同的IP地址就属于同一个子网络。
###  IP数据包
根据IP协议发送的数据，就叫做IP数据包。IP数据包直接放在以太网数据包的"数据"部分，以避免影响以太网数据包的规则。
具体来说，IP数据包也分为"标头"和"数据"两个部分。
- "标头"部分主要包括版本、长度、IP地址等信息；
- "数据"部分则是IP数据包的具体内容。

<img src="2.png" style="height:200px"/>


整个IP数据包的总长度最大为65,535字节。前面说过，以太网数据包的"数据"部分，最长只有1500字节。因此，如果IP数据包超过了1500字节，它就需要分割成几个以太网数据包，分开发送了。
### ARP协议
因为IP数据包是放在以太网数据包里发送的，所以必须同时对方的MAC地址和IP地址。IP地址可以通过**DNS协议**获取，但是我们不知道它的MAC地址。  
所以，我们需要一种机制，能够从IP地址得到MAC地址。分成以下两种情况。
>第一种情况，如果两台主机不在同一个子网络：

  如果两台主机不在同一个子网络，那么事实上没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的"网关"（gateway），让网关去处理。
>第二种情况，如果两台主机在同一个子网络：

  可以用**ARP协议**，得到对方的MAC地址。**ARP协议**也是发出一个数据包（包含在以太网数据包中），其中包含它所要查询主机的IP地址，在对方的MAC地址这一栏，填的是FF:FF:FF:FF:FF:FF，表示这是一个"广播"地址。  
  发出数据包所在子网络的每一台主机，都会收到这个数据包，从中取出IP地址，与自身的IP地址进行比较。如果两者相同，都做出回复，向对方报告自己的MAC地址，否则就丢弃这个包。


# 五、传输层
## (1) 背景
有了MAC地址和IP地址，我们已经可以在互联网上任意两台主机上建立通信。我们还需要一个参数，表示这个数据包到底供哪个程序（进程）使用。这个参数就叫做"端口"（port），它其实是每一个使用网卡的程序的编号。 

每个数据包都发到主机的特定端口，所以不同的程序就能取到自己所需要的数据。"端口"是0到65535之间的一个整数，正好16个二进制位。0到1023的端口被系统占用，用户只能选用大于1023的端口。
## (2) 功能
"传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。只要确定主机和端口，我们就能实现程序之间的交流。

## (3) UDP协议
**UDP协议**可以在数据包中加入端口信息，UDP数据包，也是由"标头"和"数据"两部分组成。然后，把整个UDP数据包放入IP数据包的"数据"部分，而前面说过，IP数据包又是放在以太网数据包之中。
- "标头"部分主要定义了发出端口和接收端口。
- "数据"部分就是具体的内容。
UDP数据包，标头"部分一共只有8个字节，总长度不超过65,535字节，正好放进一个IP数据包。以整个以太网数据包现在变成了下面这样：

<img src="3.png" style="height:200px"/>

## (4) TCP协议
**UDP协议**的优点是比较简单，容易实现，但是缺点是可靠性较差，一旦数据包发出，无法知道对方是否收到。  
为此**TCP协议**就诞生了。这个协议非常复杂，但可以近似认为，它就是有确认机制的UDP协议，每发出一个数据包都要求确认。如果有一个数据包遗失，就收不到确认，发出方就知道有必要重发这个数据包了。  
TCP数据包和UDP数据包一样，都是内嵌在IP数据包的"数据"部分。TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割。

# 六、应用层
## (1) 背景
TCP协议可以为各种各样的程序传递数据，比如Email、WWW、FTP等等。那么，必须有不同协议规定电子邮件、网页、FTP数据的格式，这些应用程序协议就构成了"应用层"。
应用程序收到"传输层"的数据，接下来就要进行解读。由于互联网是开放架构，数据来源五花八门，必须事先规定好格式，否则根本无法解读。
## (2) 功能
"应用层"的作用，就是规定应用程序的数据格式。这是最高的一层，直接面对用户。它的数据就放在TCP数据包的"数据"部分。因此，现在的以太网的数据包就变成下面这样。
<img src="4.png" style="height:200px"/>
# 补充：
## (1) 字节概念
字节也叫Byte，是计算机数据的基本存储单位。
- 8bit(位) = 1Byte(字节)
- 1024Byte(字节) = 1KB
- 1024KB = 1MB