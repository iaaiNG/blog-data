---
title: 互联网协议
date: 2019-03-28 14:59:54
category: 互联网技术
---

为了可以帮助理解：网络优化，服务器访问，ajax请求，http协议等一系列问题，我想需要了解一下互联网协议。
互联网的核心是一系列协议，总称为"互联网协议"（Internet Protocol Suite）。它们对电脑如何连接和组网，做出了详尽的规定。理解了这些协议，就理解了互联网的原理。
<!--more-->

# 一、概述
互联网的实现，分成好几层。每一层都有自己的功能。用户接触到的，只有最上面的一层。要理解互联网，必须从最下层开始，自下而上理解每一层的功能。
- **应用层：** 规定应用程序的数据格式。
- **传输层：** 建立"端口到端口"的通信。
- **网络层：** 引进一套新的地址，使区分不同的子网络。这套地址就叫做IP地址。
- **链接层：** 对"实体层"0和1的电信号进行分组成一个个数据包，让同一子网络的计算机之间进行数据包传输。
- **实体层：** 把电脑连接起来的物理手段。它主要规定了网络的一些电气特性，作用是负责传送0和1的电信号。
- 
# 二、实体层
## (1) 背景
计算机之间要组网，要传输数据，需要先把电脑连起来，可以是用光缆、电缆、双绞线、无线电波等方式。
## (2) 功能
通过物理手段，把电脑连接起来。它主要规定了网络的一些电气特性，作用是负责传送0和1的电信号。

# 三、链接层
## (1) 背景
单纯的0和1没有任何意义，必须规定解读方式：多少个电信号算一组？每个信号位有何意义？
## (2) 功能
"链接层"对"实体层"0和1的电信号进行分组，形成一个个数据包，让同一子网络的计算机之间进行数据包传输。
## (3) 以太网协议
早期，每家公司分组方式不同。后来，被一种叫"以太网"的协议，占据了主导地位。
### 分组方式
以太网规定协议规定，一组电信号构成一个数据包，叫做"帧"（Frame）。  
每一帧分成两个部分：标头（Head）和数据（Data）。
- "标头"包含数据包的一些说明项，比如发送者、接受者、数据类型等等，长度固定为18字节。；
- "数据"则是数据包的具体内容，长度最短为46字节，最长为1500字节。

<img src="1.png" style="height:200px"/>

因此，整个"帧"最短为64字节，最长为1518字节。不然，就必须分割成多个帧进行发送。

### MAC地址
以太网协议规定，连入网络的所有设备，必须都具有"网卡"接口。数据包只能在网卡之间传输。网卡的地址，就是数据包的发送地址和接收地址，这叫做MAC地址。每块网卡的MAC地址是独一无二的。
### 广播
假如两台主机在同一个子网络，可以通过**ARP协议**，使以太网数据包知道接收方的MAC地址。（后文有介绍ARP协议）
然后以太网协议将采用"广播"的方式，向同一个子网络内所有计算机发送数据包，让每台计算机自己判断，是否为接收方。

# 四、网络层
## (1) 背景
因为以太网协议以广播的方式传输数据，效率有限，所以只能局限在发送者所在的子网络。为此需要区分哪些MAC地址属于同一个子网络，哪些不是。如果是同一个子网络，就采用广播方式发送，否则就采用"路由"方式发送。（"路由"的意思，就是指如何向不同的子网络分发数据包，这是一个很大的主题，本文不涉及。）
## (1) 功能
"网络层"的作用是引进一套新的地址，使得我们能够区分不同的计算机是否属于同一个子网络。这套地址就叫做IP地址。
## (2) IP协议
IP地址被IP协议所定义。目前，广泛采用的是IP协议第四版，简称IPv4。这个版本规定，网络地址由32个二进制位组成。
### 子网掩码
IP协议规定里的"子网掩码"，就是表示子网络特征的一个参数。它在形式上等同于IP地址，也是一个32位二进制数字，它的网络部分全部为1，主机部分全部为0。把IP地址与子网掩码进行"按位与"运算，结果相同的IP地址就属于同一个子网络。
###  IP数据包
根据IP协议发送的数据，就叫做IP数据包。IP数据包直接放在以太网数据包的"数据"部分，以避免影响以太网数据包的规则。
具体来说，IP数据包也分为"标头"和"数据"两个部分。
- "标头"部分主要包括版本、长度、IP地址等信息；
- "数据"部分则是IP数据包的具体内容。

<img src="2.png" style="height:200px"/>


整个IP数据包的总长度最大为65,535字节。前面说过，以太网数据包的"数据"部分，最长只有1500字节。因此，如果IP数据包超过了1500字节，它就需要分割成几个以太网数据包，分开发送了。
### ARP协议
因为IP数据包是放在以太网数据包里发送的，所以必须同时对方的MAC地址和IP地址。IP地址可以通过**DNS协议**获取，但是我们不知道它的MAC地址。  
所以，我们需要一种机制，能够从IP地址得到MAC地址。分成以下两种情况。
>第一种情况，如果两台主机不在同一个子网络：

  如果两台主机不在同一个子网络，那么事实上没有办法得到对方的MAC地址，只能把数据包传送到两个子网络连接处的"网关"（gateway），让网关去处理。
>第二种情况，如果两台主机在同一个子网络：

  可以用**ARP协议**，得到对方的MAC地址。**ARP协议**也是发出一个数据包（包含在以太网数据包中），其中包含它所要查询主机的IP地址，在对方的MAC地址这一栏，填的是FF:FF:FF:FF:FF:FF，表示这是一个"广播"地址。  
  发出数据包所在子网络的每一台主机，都会收到这个数据包，从中取出IP地址，与自身的IP地址进行比较。如果两者相同，都做出回复，向对方报告自己的MAC地址，否则就丢弃这个包。


# 五、传输层
## (1) 背景
有了MAC地址和IP地址，我们已经可以在互联网上任意两台主机上建立通信。我们还需要一个参数，表示这个数据包到底供哪个程序（进程）使用。这个参数就叫做"端口"（port），它其实是每一个使用网卡的程序的编号。 

每个数据包都发到主机的特定端口，所以不同的程序就能取到自己所需要的数据。"端口"是0到65535之间的一个整数，正好16个二进制位。0到1023的端口被系统占用，用户只能选用大于1023的端口。
## (2) 功能
"传输层"的功能，就是建立"端口到端口"的通信。相比之下，"网络层"的功能是建立"主机到主机"的通信。只要确定主机和端口，我们就能实现程序之间的交流。

## (3) UDP协议
**UDP协议**可以在数据包中加入端口信息，UDP数据包，也是由"标头"和"数据"两部分组成。然后，把整个UDP数据包放入IP数据包的"数据"部分，而前面说过，IP数据包又是放在以太网数据包之中。
- "标头"部分主要定义了发出端口和接收端口。
- "数据"部分就是具体的内容。
UDP数据包，标头"部分一共只有8个字节，总长度不超过65,535字节，正好放进一个IP数据包。以整个以太网数据包现在变成了下面这样：

<img src="3.png" style="height:200px"/>

## (4) TCP协议
**UDP协议**的优点是比较简单，容易实现，但是缺点是可靠性较差，一旦数据包发出，无法知道对方是否收到。  
为此**TCP协议**就诞生了。这个协议非常复杂，但可以近似认为，它就是有确认机制的UDP协议，每发出一个数据包都要求确认。如果有一个数据包遗失，就收不到确认，发出方就知道有必要重发这个数据包了。  
TCP数据包和UDP数据包一样，都是内嵌在IP数据包的"数据"部分。TCP数据包没有长度限制，理论上可以无限长，但是为了保证网络的效率，通常TCP数据包的长度不会超过IP数据包的长度，以确保单个TCP数据包不必再分割。

# 六、应用层
## (1) 背景
TCP协议可以为各种各样的程序传递数据，比如Email、WWW、FTP等等。那么，必须有不同协议规定电子邮件、网页、FTP数据的格式，这些应用程序协议就构成了"应用层"。
应用程序收到"传输层"的数据，接下来就要进行解读。由于互联网是开放架构，数据来源五花八门，必须事先规定好格式，否则根本无法解读。
## (2) 功能
"应用层"的作用，就是规定应用程序的数据格式。这是最高的一层，直接面对用户。它的数据就放在TCP数据包的"数据"部分。因此，现在的以太网的数据包就变成下面这样。
<img src="4.png" style="height:200px"/>

# 七、一个实例：访问网页
上面是从设计者的角度看问题，下面切换到用户的角度，看看用户是如何从上至下，与这些协议互动的。
## (1) 用户首先设置参数
* 本机的IP地址：192.168.1.100
* 子网掩码：255.255.255.0
* 网关的IP地址：192.168.1.1
* DNS的IP地址：8.8.8.8
然后，在浏览器地址栏输入了网址：www.google.com。这意味着，浏览器要向Google发送一个网页请求的数据包。
## (2) DNS协议
DNS协议可以将这个网址转换成IP地址。已知DNS服务器为8.8.8.8，于是向这个地址发送一个DNS数据包（53端口）。  
DNS服务器做出响应，告诉我们Google的IP地址是172.194.72.105。
## (3) 子网掩码
本机对自己的IP地址192.168.1.100和Google的IP地址172.194.72.105，做按位与运算（两个数位都为1，结果为1，否则为0），两个计算结果显然不相等，所以Google与本机不在同一个子网络。
## (4) 应用层协议
浏览网页用的是HTTP协议，假定这个部分的长度为4960字节，它会被嵌在TCP数据包之中。
## (5) TCP协议
TCP数据包需要设置端口，接收方（Google）的HTTP端口默认是80，发送方（本机）的端口是一个随机生成的1024-65535之间的整数，假定为51775。
TCP数据包的标头长度为20字节，加上嵌入HTTP的数据包，总长度变为4980字节。
## (6) IP协议
然后，TCP数据包再嵌入IP数据包。IP数据包需要设置双方的IP地址，这是已知的，发送方是192.168.1.100（本机），接收方是172.194.72.105（Google）。  
IP数据包的标头长度为20字节，加上嵌入的TCP数据包，总长度变为5000字节。
## (7) 以太网协议
最后，IP数据包嵌入以太网数据包。以太网数据包需要设置双方的MAC地址，发送方为本机的网卡MAC地址，接收方为网关192.168.1.1的MAC地址（通过ARP协议得到）。  
以太网数据包的数据部分，最大长度为1500字节，而现在的IP数据包长度为5000字节。因此，IP数据包必须分割成四个包。因为每个包都有自己的IP标头（20字节），所以四个包的IP数据包的长度分别为1500、1500、1500、560。
## (8) 服务器端响应
经过多个网关的转发，Google的服务器172.194.72.105，收到了这四个以太网数据包。  
根据IP标头的序号，Google将四个包拼起来，取出完整的TCP数据包，然后读出里面的"HTTP请求"，接着做出"HTTP响应"，再用TCP协议发回来。  
本机收到HTTP响应以后，就可以将网页显示出来，完成一次网络通信。

# 补充：
## (1) 字节概念
字节也叫Byte，是计算机数据的基本存储单位。
- 8bit(位) = 1Byte(字节)
- 1024Byte(字节) = 1KB
- 1024KB = 1MB

## (2) TCP协议
TCP 协议的作用是，保证数据通信的完整性和可靠性，防止丢包。
### TCP 数据包的编号
TCP 负载实际为1400字节左右。一次性发送大量数据，就必须分成多个包。比如，一个 10MB 的文件，需要发送7100多个包。  
发送的时候，TCP 协议为每个包编号（sequence number，简称 SEQ），以便接收的一方按照顺序还原。万一发生丢包，也可以知道丢失的是哪一个包。  
第一个包的编号是一个随机数。为了便于理解，这里就把它称为1号包。假定这个包的负载长度是100字节，那么可以推算出下一个包的编号应该是101。
### TCP 数据包的组装
收到 TCP 数据包以后，组装还原是操作系统完成的。应用程序不会直接处理 TCP 数据包。  
TCP 并没有提供任何机制，表示原始文件的大小，这由应用层的协议来规定。比如，HTTP 协议就有一个头信息Content-Length，表示信息体的大小。  
应用程序收到组装好的原始数据，以浏览器为例，就会根据 HTTP 协议的Content-Length字段正确读出一段段的数据。TCP 数据包里面有一个端口（port）参数，就是用来指定转交给监听该端口的应用程序。
### 慢启动和 ACK
TCP 协议为了做到效率与可靠性的统一，设计了一个慢启动（slow start）机制。开始的时候，发送得较慢，然后根据丢包的情况，调整速率：如果不丢包，就加快发送速度；如果丢包，就降低发送速度。  
默认情况下，接收方每收到两个 TCP 数据包，就要发送一个确认消息。"确认"的英语是 acknowledgement，所以这个确认消息就简称 ACK。
### 数据包的遗失处理
每一个数据包都带有下一个数据包的编号。如果下一个数据包没有收到，那么 ACK 的编号就不会发生变化。

## (3) 面试题
### 从输入 url 到 页面加载 发生了什么
1. 客户端的地址栏输入URL并按下回车。
2. 客户端查找当前URL是否存在缓存，并比较缓存是否过期。
3. DNS解析URL对应的IP。
4. 根据IP建立TCP连接（三次握手）。
5. 客户端发起HTTP请求。
6. 服务器处理请求，客户端接收服务器响应。
7. 渲染页面，构建DOM树。
8. 关闭TCP连接（四次挥手）

# 参考
- *互联网协议入门：http://www.ruanyifeng.com/blog/2012/05/internet_protocol_suite_part_i.html*
- *TCP协议介绍：http://www.ruanyifeng.com/blog/2017/06/tcp-protocol.html*